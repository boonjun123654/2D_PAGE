<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>2D 开奖页面</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* 顶部黑条与菜单 */
    .topbar{background:#111;color:#fff;height:48px;display:flex;align-items:center;padding:0 12px;}
    .menu{position:relative;}
    .menu-btn{background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer;line-height:1;}
    .menu-list{display:none;position:absolute;left:0;top:48px;background:#222;border:1px solid #333;border-radius:8px;min-width:140px;padding:6px 0;z-index:10}
    .menu.open .menu-list{display:block;}
    .menu-list a{display:block;padding:10px 14px;color:#fff;text-decoration:none}
    .menu-list a:hover{background:#333}

    /* ✅ 新增：logo 样式 */
    .brand{ display:flex; align-items:center; margin-left:auto; }
    .brand img{ height:28px; display:block; }
    @media (min-width:768px){ .brand img{ height:32px; } }

    /* 让内容与顶条有间距 */
    .container{margin-top:12px;}
  </style>
</head>
<body>
  <!-- 顶部黑线+菜单 -->
  <div class="topbar">
    <div class="menu" id="mainMenu">
      <button class="menu-btn" aria-label="菜单">☰</button>
      <ul class="menu-list">
        <li><a href="/">主页</a></li>
        <li><a href="/history">历史记录</a></li>
      </ul>
    </div>

    <!-- logo，点它返回主页 -->
    <a class="brand" href="/" aria-label="X33">
      <img src="{{ url_for('static', filename='x33-logo.png') }}" alt="X33 Logo">
    </a>
  </div>

<div class="container">
  <!-- 去掉了原来的 “2D” 标题 -->
  <div class="market-area" id="draw-area"></div>
</div>

<script>
/* ====== 菜单开关 ====== */
(function(){
  const menu = document.getElementById('mainMenu');
  const btn = menu.querySelector('.menu-btn');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
  document.addEventListener('click', ()=> menu.classList.remove('open'));
})();

/* ====== 日期与市场 ====== */
function pad(n){ return n.toString().padStart(2,'0'); }

const markets = [
  { code: 'M', name: 'Magnum',       color: '#ffff00', logo: 'magnum.png' },
  { code: 'P', name: 'Damacai',      color: '#0000ff', logo: 'damacai.png' },
  { code: 'T', name: 'SportsToto',   color: '#cc0000', logo: 'toto.png' },
  { code: 'S', name: 'Singapore',    color: '#4c8ed1', logo: 'singapore.png' },
  { code: 'H', name: 'Grand Dragon', color: '#ff0000', logo: 'grand_dragon.png' },
  { code: 'E', name: '9 Lotto',      color: '#ffa500', logo: '9lotto.png' },
  { code: 'B', name: 'Sabah',        color: '#e51d20', logo: 'sabah.png' },
  { code: 'K', name: 'Sandakan',     color: '#008835', logo: 'sandakan.png' },
  { code: 'W', name: 'Sarawak',      color: '#00540e', logo: 'sarawak.png' }
];

// 定时器容器，防止重复
const timers = {};
function clearTimersFor(code){ (timers[code]||[]).forEach(id=>clearTimeout(id)); timers[code]=[]; }
function addTimer(code,id){ (timers[code]||(timers[code]=[])).push(id); }

// 生成「YYYYMMDD/HH50」
function formatCode(dateObj, hour){
  const y=dateObj.getFullYear(), m=pad(dateObj.getMonth()+1), d=pad(dateObj.getDate());
  return `${y}${m}${d}/${pad(hour)}50`;
}

/* 按你的规则：
   [H:51:00,(H+1):39:59] 读 YYYYMMDD/H50；[H:40:00,H:50:59] 空白等待 */
function computeFixedCodeAndElapsed(now=new Date()){
  const h=now.getHours(), m=now.getMinutes();
  const base=new Date(now); base.setSeconds(0,0);

  if (m>=40 && m<51) return {code:null, elapsed:0, blank:true};

  if (m>=51){
    const start=new Date(base); start.setHours(h,51,0,0);
    return {code:formatCode(base,h), elapsed:(now-start)/1000, blank:false};
  }

  // m<40，上一小时
  const codeDate=new Date(base);
  const codeHour=(h+23)%24;
  if (h===0) codeDate.setDate(codeDate.getDate()-1);
  const start=new Date(base);
  if (h===0) start.setDate(start.getDate()-1);
  start.setHours(codeHour,51,0,0);
  return {code:formatCode(codeDate,codeHour), elapsed:(now-start)/1000, blank:false};
}

function labelFromCode(code){
  if (!code) return '';
  const [ymd,hhmm]=code.split('/');
  const y=+ymd.slice(0,4), m=+ymd.slice(4,6)-1, d=+ymd.slice(6,8);
  const dt=new Date(y,m,d);
  const dateStr=dt.toLocaleDateString('en-GB',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}).replace(',','');
  return `${dateStr}/${hhmm.slice(0,2)}`;
}
function getHeaderCodeForNow(){
  const r=computeFixedCodeAndElapsed(new Date());
  if (r.code) return r.code;
  const now=new Date(); const prev=new Date(now); prev.setHours(now.getHours()-1,0,0,0);
  return formatCode(prev, prev.getHours());
}

/* ===== 页面启动 ===== */
window.onload = () => {
  const container=document.getElementById('draw-area');
  const whiteTextMarkets=['P','T','S','H','B','K','W'];
  const initLabel=labelFromCode(getHeaderCodeForNow());

  markets.forEach(m=>{
    const textColor=whiteTextMarkets.includes(m.code)?'white':'black';
    const box=document.createElement('div');
    box.className='draw-box';
    box.id=`draw-box-${m.code}`;
    box.innerHTML=`
      <div class="market-header" style="background-color:${m.color};color:${textColor};">
        <img src="/static/${m.logo}" alt="${m.name}" class="market-logo">
        <div class="market-title">
          <div><strong>${m.name} 2D</strong></div>
          <div>( <span id="datehour-${m.code}">${initLabel}</span> )</div>
        </div>
      </div>
      <div class="section-title">1st Prize</div>
      <div class="result-table">
        <div class="result-box blank" id="odd-even-${m.code}">--</div>
        <div class="result-box blank" id="head-${m.code}">--</div>
        <div class="result-box blank" id="big-small-${m.code}">--</div>
      </div>
      <div class="section-title">Special Prize</div>
      <div class="result-table" style="grid-template-columns: repeat(3, 1fr);">
        <div class="result-box blank" id="special-${m.code}-0">--</div>
        <div class="result-box blank" id="special-${m.code}-1">--</div>
        <div class="result-box blank" id="special-${m.code}-2">--</div>
      </div>`;
    container.appendChild(box);
  });

  runCycleOnce();
  scheduleNext51();
  scheduleClearAt40();
};

function updateHeaderDateHour(code){
  const label=labelFromCode(code);
  markets.forEach(m=>{
    const span=document.getElementById(`datehour-${m.code}`);
    if (span) span.textContent=label;
  });
}

function millisToNext40s(){
  const now=new Date();
  const t=new Date(now);
  t.setMinutes(40,0,0);
  if (now>=t) t.setHours(t.getHours()+1);
  return t-now;
}

function clearAllUI(){
  markets.forEach(m=>{
    clearTimersFor(m.code);
    ['odd-even','head','big-small'].forEach(k=>{
      const el=document.getElementById(`${k}-${m.code}`); if(el){el.textContent='--';el.classList.add('blank');}
    });
    for(let i=0;i<3;i++){ const s=document.getElementById(`special-${m.code}-${i}`); if(s){s.textContent='--';s.classList.add('blank');} }
  });
}

function scheduleClearAt40(){
  const loop=()=>{
    const now=new Date();
    const t=new Date(now); t.setMinutes(40,0,0); if(now>=t)t.setHours(t.getHours()+1);
    setTimeout(()=>{ clearAllUI(); loop(); }, t-now);
  }; loop();
}

function scheduleNext51(){
  const loop=()=>{
    const now=new Date();
    const t=new Date(now); t.setHours(now.getMinutes()>=51?now.getHours()+1:now.getHours(),51,0,0);
    setTimeout(()=>{ runCycleOnce(); loop(); }, t-now);
  }; loop();
}

function runCycleOnce(){
  const {code, elapsed, blank}=computeFixedCodeAndElapsed(new Date());
  if (code) updateHeaderDateHour(code);
  if (blank || !code){ clearAllUI(); return; }
  startDraw(code, true, elapsed);
}

async function fetchDrawWithRetry(marketCode, code, maxRetrySec=60, intervalSec=2){
  const to40=Math.max(0, Math.floor(millisToNext40s()/1000)-1);
  const deadline=Date.now()+Math.min(maxRetrySec,to40)*1000;
  while(Date.now()<deadline){
    try{
      const r=await fetch(`/draw?market=${marketCode}&code=${encodeURIComponent(code)}&strict=1`);
      const d=await r.json();
      const specials=((d.special||d.specials||[])).filter(Boolean);
      if ((specials&&specials.length)||(d.head&&d.head!=='')) return d;
    }catch(_){}
    await new Promise(r=>setTimeout(r, intervalSec*1000));
  }
  try{
    const r=await fetch(`/draw?market=${marketCode}&code=${encodeURIComponent(code)}&strict=1`);
    return await r.json();
  }catch(_){ return {}; }
}

function startDraw(fixedCode, showImmediateFirst=true, elapsedSec=0){
  markets.forEach(async (m)=>{
    clearTimersFor(m.code);
    resetBoxes(m.code);

    const data=await fetchDrawWithRetry(m.code, fixedCode, 60, 2);
    const headFromServer=(data.head!=null && data.head!=='')?parseInt(data.head,10):null;
    const nums=((data.special||data.specials||[])).slice(0,3).map(n=>n.toString().padStart(2,'0'));

    const e=Math.max(0, elapsedSec||0);
    let shown=0;
    if(nums.length>0){ if(e>=0)shown=1; if(e>=10)shown=2; if(e>=20)shown=3; }
    for(let k=0;k<shown;k++) showSpecial(m.code,k,nums[k]);

    if(e>=30){ renderHeadAndTypes(m.code, headFromServer, nums, data); return; }

    const scheduleAt=(targetSec,fn)=>{ const delay=Math.max(0,targetSec-e)*1000; addTimer(m.code, setTimeout(fn, delay)); };
    if(shown===0 && nums.length>0){ if(showImmediateFirst) showSpecial(m.code,0,nums[0]); else scheduleAt(0,()=>showSpecial(m.code,0,nums[0])); }
    if(nums.length>1 && shown<=1) scheduleAt(10, ()=>showSpecial(m.code,1,nums[1]));
    if(nums.length>2 && shown<=2) scheduleAt(20, ()=>showSpecial(m.code,2,nums[2]));
    scheduleAt(30, ()=>renderHeadAndTypes(m.code, headFromServer, nums, data));
  });
}

function resetBoxes(code){
  for(let j=0;j<3;j++){ const s=document.getElementById(`special-${code}-${j}`); if(s){s.textContent='--';s.classList.add('blank');} }
  const headBox=document.getElementById(`head-${code}`);
  const oddEven=document.getElementById(`odd-even-${code}`);
  const bigSmall=document.getElementById(`big-small-${code}`);
  headBox.textContent='--'; oddEven.textContent='--'; bigSmall.textContent='--';
  headBox.classList.add('blank'); oddEven.classList.add('blank'); bigSmall.classList.add('blank');
}

function showSpecial(code, idx, val){
  const el=document.getElementById(`special-${code}-${idx}`);
  if(!el) return; el.textContent=val; el.classList.remove('blank');
}

function renderHeadAndTypes(code, headFromServer, nums, data){
  const headBox=document.getElementById(`head-${code}`);
  const oddEven=document.getElementById(`odd-even-${code}`);
  const bigSmall=document.getElementById(`big-small-${code}`);
  const chosen=(headFromServer!==null) ? headFromServer :
                (nums.length?parseInt(nums[Math.floor(Math.random()*nums.length)],10):NaN);
  if(!Number.isNaN(chosen)){
    headBox.textContent=chosen.toString().padStart(2,'0'); headBox.classList.remove('blank');
    oddEven.textContent=(data.parity && (data.parity==='单' || data.parity==='双')) ? data.parity : (chosen%2===0?'双':'单');
    oddEven.classList.remove('blank');
    bigSmall.textContent=(data.size && (data.size==='大' || data.size==='小')) ? data.size : (chosen>=50?'大':'小');
    bigSmall.classList.remove('blank');
    for(let j=0;j<3;j++){ const s=document.getElementById(`special-${code}-${j}`);
      if(s && s.textContent===chosen.toString().padStart(2,'0')){ s.textContent='--'; s.classList.add('blank'); break; }
    }
  }else{
    headBox.textContent='ERR'; headBox.classList.remove('blank');
  }
}
</script>
</body>
</html>

