<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>X33</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .topbar{background:#111;color:#fff;height:48px;display:flex;align-items:center;padding:0 12px;}
    .menu{position:relative;}
    .menu-btn{background:transparent;border:0;color:#fff;font-size:22px;cursor:pointer;line-height:1;}
    .menu-list{display:none;position:absolute;left:0;top:48px;background:#222;border:1px solid #333;border-radius:8px;min-width:140px;padding:6px 0;z-index:10}
    .menu.open .menu-list{display:block;}
    .menu-list a{display:block;padding:10px 14px;color:#fff;text-decoration:none}
    .menu-list a:hover{background:#333}
    .filters{display:flex;gap:10px;align-items:center;padding:12px 8px;flex-wrap:wrap}
    .filters label{font-weight:600}
    .filters input,.filters select{padding:6px 8px;border:1px solid #ccc;border-radius:8px}
    .filters button{padding:8px 14px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer}
    .container{margin-top:12px;}
  </style>
</head>
<body>
  <!-- 顶部黑线+菜单 -->
  <div class="topbar">
    <div class="menu" id="mainMenu">
      <button class="menu-btn" aria-label="菜单">☰</button>
      <ul class="menu-list">
        <li><a href="/">主页</a></li>
        <li><a href="/history">历史记录</a></li>
      </ul>
    </div>
  </div>

<div class="container">
  <div class="filters">
    <label>日期：
      <input type="date" id="pickDate">
    </label>
    <label>时段：
      <select id="pickSlot">
        <option value="">请选择</option>
      </select>
    </label>
    <button id="queryBtn">查询</button>
  </div>
  <div class="market-area" id="draw-area"></div>
</div>

<script>
/* 菜单 */
(function(){
  const menu=document.getElementById('mainMenu');
  const btn=menu.querySelector('.menu-btn');
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
  document.addEventListener('click', ()=> menu.classList.remove('open'));
})();

function pad(n){ return n.toString().padStart(2,'0'); }

const markets = [
  { code: 'MGV 21', name: 'MGV 21',       color: '#ffff00', logo: 'MGV21.png' },
  { code: 'UCA 68', name: 'UCA 68',      color: '#0000ff', logo: 'UCA68.png' },
  { code: 'SFC 99', name: 'SFC 99',   color: '#cc0000', logo: 'SFC99.png' }
];

function buildBoxes(label){
  const container=document.getElementById('draw-area');
  container.innerHTML='';
  const whites=['P','T','S','H','B','K','W'];
  markets.forEach(m=>{
    const textColor=whites.includes(m.code)?'white':'black';
    const box=document.createElement('div');
    box.className='draw-box';
    box.id=`draw-box-${m.code}`;
    box.innerHTML=`
      <div class="market-header" style="background-color:${m.color};color:${textColor};">
        <img src="/static/${m.logo}" alt="${m.name}" class="market-logo">
        <div class="market-title">
          <div><strong>${m.name} 2D</strong></div>
          <div>( <span id="datehour-${m.code}">${label}</span> )</div>
        </div>
      </div>
      <div class="section-title">1st Prize</div>
      <div class="result-table">
        <div class="result-box blank" id="odd-even-${m.code}">--</div>
        <div class="result-box blank" id="head-${m.code}">--</div>
        <div class="result-box blank" id="big-small-${m.code}">--</div>
      </div>
      <div class="section-title">Special Prize</div>
      <div class="result-table" style="grid-template-columns: repeat(3, 1fr);">
        <div class="result-box blank" id="special-${m.code}-0">--</div>
        <div class="result-box blank" id="special-${m.code}-1">--</div>
        <div class="result-box blank" id="special-${m.code}-2">--</div>
      </div>`;
    container.appendChild(box);
  });
}

function labelFromCode(code){
  const [ymd,hhmm]=code.split('/');
  const y=+ymd.slice(0,4), m=+ymd.slice(4,6)-1, d=+ymd.slice(6,8);
  const dt=new Date(y,m,d);
  const dateStr=dt.toLocaleDateString('en-GB',{weekday:'short',day:'2-digit',month:'short',year:'numeric'}).replace(',','');
  return `${dateStr}/${hhmm.slice(0,2)}`;
}

function resetRow(code){
  ['odd-even','head','big-small'].forEach(k=>{
    const el=document.getElementById(`${k}-${code}`); if(el){el.textContent='--';el.classList.add('blank');}
  });
  for(let i=0;i<3;i++){ const s=document.getElementById(`special-${code}-${i}`); if(s){s.textContent='--';s.classList.add('blank');} }
}

function paintRow(code, data){
  const head=(data.head && data.head!=='') ? data.head.toString().padStart(2,'0') : null;
  const sp=((data.special||data.specials||[])).slice(0,3).map(n=>n.toString().padStart(2,'0'));
  if (sp.length){
    sp.forEach((v,i)=>{ const el=document.getElementById(`special-${code}-${i}`); if(el){el.textContent=v; el.classList.remove('blank');} });
  }
  if (head){
    const hb=document.getElementById(`head-${code}`); hb.textContent=head; hb.classList.remove('blank');
    const oe=document.getElementById(`odd-even-${code}`);
    const bs=document.getElementById(`big-small-${code}`);
    oe.textContent=(data.parity && (data.parity==='Odd' || data.parity==='Even')) ? data.parity : ((parseInt(head,10)%2===0)?'Even':'Odd');
    bs.textContent=(data.size && (data.size==='Big' || data.size==='Small')) ? data.size : ((parseInt(head,10)>=50)?'Big':'Small');
    oe.classList.remove('blank'); bs.classList.remove('blank');
  }
}

async function queryOnce(){
  const d=document.getElementById('pickDate').value; // yyyy-mm-dd
  const s=document.getElementById('pickSlot').value; // "HH50"
  if (!d || !s) return;

  const ymd=d.replaceAll('-','');                 // "YYYYMMDD"
  const code=`${ymd}/${s}`;                       // 固定 code
  buildBoxes(labelFromCode(code));                // 重新渲染容器与抬头

  // 拉取所有市场并渲染
  for (const m of markets){
    resetRow(m.code);
    try{
      const res=await fetch(`/draw?market=${m.code}&code=${encodeURIComponent(code)}&strict=1`);
      const data=await res.json();
      paintRow(m.code, data);
    }catch(_){}
  }
}

window.addEventListener('load', ()=>{
  // 初始化日期为今天
  const dt=document.getElementById('pickDate');
  const now=new Date();
  dt.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;

  // 填充 09..23 时段（HH:50）
  const sel=document.getElementById('pickSlot');
  for(let h=9; h<=23; h++){
    const opt=document.createElement('option');
    opt.value=`${pad(h)}50`;
    opt.textContent=`${pad(h)}:50`;
    sel.appendChild(opt);
  }

  // 初始默认选当前「固定读 HH50」的小时
  let defaultHour = now.getMinutes()>=51 ? now.getHours() : (now.getHours()+23)%24;
  if (defaultHour < 9) defaultHour = 9;
  sel.value = `${pad(defaultHour)}50`;

  // 初次构建空框
  buildBoxes(labelFromCode(`${dt.value.replaceAll('-','')}/${sel.value}`));

  document.getElementById('queryBtn').addEventListener('click', queryOnce);
});
</script>
</body>
</html>
